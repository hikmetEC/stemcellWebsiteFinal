<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>STEMCELL Blog</title>

  <!-- Font: Ana sayfayla aynı -->
  <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Quill CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <!-- highlight.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">

  <style>
    *{margin:0;padding:0;box-sizing:border-box}

    :root{
      --stem-text:#0d1b62;
      --stem-text-soft:#1a2a7a;;
      --stem-title:#0d1b62;
    }

    body{
      font-family:'Archivo', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height:1.6;
      color: var(--stem-text);

      background: #000d34 url("assets/images/page2.png") center top / cover no-repeat fixed;
      position:relative;
      min-height:100vh;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.22);
      z-index:0;
      pointer-events:none;
    }
    header, main, .img-modal{ position:relative; z-index:1; }

    header{
      background:#000d34;
      color:#fff;
      padding:18px 40px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:10px;
    }
    header h1{
      font-size:1.9rem;
      letter-spacing:0.03em;
    }
    .logo-link{
      color:#fff;
      text-decoration:none;
    }
    .logo-link:hover{
      opacity:0.95;
    }

    nav{
      display:flex;
      gap:14px;
      align-items:center;
      font-size:.94rem;
    }
    nav a{
      position:relative;
      color:#cfe4ff;
      text-decoration:none;
      font-weight:600;
      padding-bottom:3px;
    }
    nav a::after{
      content:'';
      position:absolute;
      left:0;
      bottom:0;
      width:0;
      height:2px;
      background:#cfe4ff;
      transition:width .2s ease;
    }
    nav a:hover::after{
      width:100%;
    }
    nav a.active{
      color:#ffffff;
    }
    nav a.active::after{
      width:100%;
    }

    main{
      width:90%;
      max-width:1400px;
      margin:3% auto;
    }
    h2{
      color: var(--stem-title);
      margin-bottom:1%;
      font-size:1.6rem;
    }

    .layout{
      display:grid;
      grid-template-columns:25% 33% 38%;
      column-gap:3%;
      align-items:flex-start;
    }
    @media(max-width:1000px){
      .layout{
        grid-template-columns:100%;
        row-gap:20px;
      }
    }

    .panel{
      background: rgba(203,216,255,0.90);
      color:#0d1b62;
      border-radius:38px;
      box-shadow:0 18px 40px rgba(0,0,0,0.35);
      padding:4%;
      border:none;

      backdrop-filter:none;
      -webkit-backdrop-filter:none;
    }

    form{
      display:flex;
      flex-direction:column;
      gap:0.7rem;
    }

    input{
      padding:0.6rem;
      border-radius:6px;
      border:1px solid rgba(0,0,0,0.18);
      font-size:.95rem;
      width:100%;
      font-family:'Archivo', sans-serif;
      background: rgba(255,255,255,0.90);
    }

    #editor{
      height:14rem;
      background: rgba(255,255,255,0.90);
      border-radius:0 0 6px 6px;
    }

    button[type="submit"]{
      background:#004aad;
      color:#fff;
      padding:0.7rem;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-size:1rem;
      font-weight:600;
      margin-top:0.3rem;
      width:100%;
      font-family:'Archivo', sans-serif;
    }
    button[type="submit"]:hover{
      background:#00327a;
    }

    .msg{
      margin-top:0.4rem;
      font-size:.85rem;
      text-align:center;
    }
    .msg.error{color:#c0392b}
    .msg.success{color:#27ae60}
    .small{
      font-size:.8rem;
      color:#666;
      margin-top:0.5rem;
      text-align:center;
    }

    .filters{
      display:flex;
      gap:0.5rem;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:0.7rem;
      margin-top:4px;
    }
    .filters input,
    .filters select{
      padding:0.4rem 0.6rem;
      border-radius:6px;
      border:1px solid rgba(0,0,0,0.18);
      font-size:.9rem;
      min-width:30%;
      font-family:'Archivo', sans-serif;
      background: rgba(255,255,255,0.90);
    }

    input,
    .filters input,
    .filters select{
      background: rgba(255,255,255,0.85);
      border:1px solid rgba(13,27,98,0.18);
      color:#0d1b62;
    }

    .ql-toolbar.ql-snow,
    .ql-container.ql-snow{
      background: rgba(255,255,255,0.85);
      border-color: rgba(13,27,98,0.18);
    }

    .ql-editor{
      color:#0d1b62;
    }

    .posts-list{
      padding:0;
      max-height:60vh;
      overflow-y:auto;
    }

    .placeholder{
      color:#222;
      font-size:.9rem;
      text-align:center;
      padding:0.5rem 0;
    }

    .post-item{
      padding:0.7rem 0.6rem;
      border-bottom:1px solid rgba(0,0,0,0.08);
      cursor:pointer;
      border-radius:8px;
      background: rgba(255,255,255,0.15);
    }
    .post-item:last-child{
      border-bottom:none;
    }
    .post-item-title{
      font-weight:600;
      margin-bottom:0.25rem;
      font-size:.98rem;
      color:#0b1b3a;
    }
    .post-item-meta{
      font-size:.8rem;
      color:#1d2b44;
      margin-bottom:0.35rem;
      opacity:0.8;
    }
    .post-item-excerpt{
      font-size:.9rem;
      color:#0f223f;
      opacity:0.9;
    }
    .post-item:hover{
      background: rgba(255,255,255,0.22);
    }
    .post-item.active{
      background: rgba(226,236,255,0.55);
      border:1px solid rgba(0,74,173,0.20);
    }

    .detail-box{
      padding:0;
      min-height:4rem;
    }
    .detail-box.hidden{
      display:none;
    }
    .detail-box h2{
      margin-bottom:0.4rem;
      font-size:1.4rem;
    }
    .detail-meta{
      font-size:.85rem;
      color:#1d2b44;
      margin-bottom:0.6rem;
      opacity:0.85;
    }
    .detail-content{
      white-space:normal;
      font-size:.95rem;
      color:#0f223f;
    }
    .detail-content img{
      max-width:70%;
      height:auto;
      border-radius:6px;
      margin:0.6rem auto 0;
      display:block;
      cursor:pointer;
    }

    .ql-toolbar.ql-snow{
      border-radius:6px 6px 0 0;
      font-family:'Archivo', sans-serif;
      background: rgba(255,255,255,0.90);
      border-color: rgba(0,0,0,0.15);
    }
    .ql-container.ql-snow{
      border-radius:0 0 6px 6px;
      font-family:'Archivo', sans-serif;
      background: rgba(255,255,255,0.90);
      border-color: rgba(0,0,0,0.15);
    }
    .ql-editor img{
      max-width:70%;
      height:auto;
      margin:0.4rem auto;
      border-radius:6px;
      cursor:pointer;
      display:block;
    }

    .img-modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.7);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
    }
    .img-modal-content{
      position:relative;
      max-width:90%;
      max-height:90%;
    }
    .img-modal-content img{
      max-width:100%;
      max-height:100%;
      border-radius:10px;
      background:#fff;
      padding:0.4rem;
    }
    .img-modal-close{
      position:absolute;
      top:-14px;
      right:-14px;
      background:#fff;
      border-radius:50%;
      width:28px;
      height:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:bold;
      cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.4);
    }
  </style>
</head>

<body>
  <header>
    <h1><a href="index.html" class="logo-link">STEMCELL Organization</a></h1>
    <nav>
      <a href="index.html">Anasayfa</a>
      <a href="blog.html" class="active">Blog</a>
    </nav>
  </header>

  <main>
    <div class="layout">
      <aside>
        <div class="panel">
          <h2>Yeni Yazı Ekle</h2>

          <form id="postForm">
            <input type="text" id="title" placeholder="Başlık" required />
            <input type="text" id="author" placeholder="Yazar (isteğe bağlı)" />
            <div id="editor"></div>
            <button type="submit">Yayınla</button>
          </form>
          <div id="formMsg" class="msg"></div>
        </div>
      </aside>

      <section>
        <div class="panel">
          <h2>Blog Yazıları</h2>
          <div class="filters">
            <input type="text" id="searchInput" placeholder="Başlık / içerik ara..." />
            <select id="authorFilter">
              <option value="all">Tüm yazarlar</option>
            </select>
          </div>
          <div class="posts-list" id="postsList">
            <p class="placeholder" id="emptyText">Yükleniyor...</p>
          </div>
        </div>
      </section>

      <section>
        <div class="panel">
          <h2>Detay</h2>
          <div class="detail-box hidden" id="detailBox"></div>
        </div>
      </section>
    </div>
  </main>

  <div id="imageModal" class="img-modal">
    <div class="img-modal-content">
      <div class="img-modal-close" id="imageModalClose">×</div>
      <img id="imageModalImg" src="" alt="Image">
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
  <!-- auth artık kullanılmıyor; istersen silebilirsin ama kalsa da sorun değil -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>

  <!-- Quill -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <!-- highlight.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC0-_Fw3WV1feYrM6aKB9tjsyTsCaqFsTI",
      authDomain: "stemcell-blog.firebaseapp.com",
      projectId: "stemcell-blog",
      storageBucket: "stemcell-blog.firebasestorage.app",
      messagingSenderId: "545027025846",
      appId: "1:545027025846:web:2d0a915ee7d30211266f17",
      measurementId: "G-C49WN5CR4N"
    };

    firebase.initializeApp(firebaseConfig);

    firebase.firestore().settings({
      experimentalForceLongPolling: true,
      useFetchStreams: false
    });

    const db = firebase.firestore();

    const postsList    = document.getElementById('postsList');
    const detailBox    = document.getElementById('detailBox');
    const postForm     = document.getElementById('postForm');
    const formMsg      = document.getElementById('formMsg');
    const searchInput  = document.getElementById('searchInput');
    const authorFilter = document.getElementById('authorFilter');

    const imageModal      = document.getElementById('imageModal');
    const imageModalImg   = document.getElementById('imageModalImg');
    const imageModalClose = document.getElementById('imageModalClose');

    let allPosts = [];
    let currentSearch = '';
    let currentAuthor = 'all';
    let currentOpenPostId = null;

    const MAX_IMAGE_BYTES = 700 * 1024;

    function escapeHTML(str){
      return String(str).replace(/[&<>"']/g, s => ({
        '&':'&amp;',
        '<':'&lt;',
        '>':'&gt;',
        '"':'&quot;',
        "'":'&#39;'
      }[s]));
    }

    function formatRelativeDate(ts){
      if (!ts || !ts.toDate) return 'Tarih yok';
      const date = ts.toDate();
      const now = new Date();
      const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const startOfGiven = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const diffMs   = startOfToday - startOfGiven;
      const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));
      const timeStr = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
      if (diffDays === 0) return `Bugün • ${timeStr}`;
      if (diffDays === 1) return `Dün • ${timeStr}`;
      if (diffDays > 1 && diffDays < 7) return `${diffDays} gün önce`;
      return date.toLocaleDateString('tr-TR', {
        day:'2-digit', month:'2-digit', year:'numeric'
      }) + ` • ${timeStr}`;
    }

    const quill = new Quill('#editor', {
      theme: 'snow',
      placeholder: 'İçeriği buraya yaz...',
      modules: {
        toolbar: [
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'header': [1, 2, 3, false] }],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          [{ 'code-block': true }],
          ['link', 'image', 'video'],
          ['clean']
        ]
      }
    });

    function prepareContentForSave(rawHTML){
      const parser = new DOMParser();
      const doc = parser.parseFromString(rawHTML, 'text/html');
      const imgs = doc.querySelectorAll('img');
      imgs.forEach(img => {
        const id = img.getAttribute('data-image-id');
        if (id) img.removeAttribute('src');
      });
      return doc.body.innerHTML.trim();
    }

    async function resolveImagesIn(container){
      const imgs = container.querySelectorAll('img[data-image-id]');
      imgs.forEach(async (img) => {
        const id = img.getAttribute('data-image-id');
        if (!id) return;
        try{
          const snap = await db.collection('blogImages').doc(id).get();
          if (snap.exists) {
            const dataUrl = snap.data().data;
            img.src = dataUrl;
          } else {
            img.replaceWith(document.createTextNode('[Görsel bulunamadı]'));
          }
        }catch(err){
          console.error('Resim yüklenemedi:', err);
          img.replaceWith(document.createTextNode('[Görsel yüklenirken hata]'));
        }
      });
    }

    const toolbar = quill.getModule('toolbar');
    toolbar.addHandler('image', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.click();
      input.onchange = async () => {
        const file = input.files[0];
        if (!file) return;
        if (file.size > MAX_IMAGE_BYTES) {
          formMsg.textContent = 'Resim çok büyük (maks ~700KB önerilir).';
          formMsg.className = 'msg error';
          return;
        }
        const reader = new FileReader();
        reader.onload = async (e) => {
          const base64DataUrl = e.target.result;
          try{
            const docRef = await db.collection('blogImages').add({
              data: base64DataUrl,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            const imgId = docRef.id;
            const range = quill.getSelection(true) || { index: quill.getLength() };
            quill.insertEmbed(range.index, 'image', base64DataUrl, 'user');
            const editorRoot = quill.root;
            const imgs = editorRoot.querySelectorAll('img');
            const lastImg = imgs[imgs.length - 1];
            if (lastImg) lastImg.setAttribute('data-image-id', imgId);
          }catch(err){
            console.error('Resim kaydedilirken hata:', err);
            formMsg.textContent = 'Resim kaydedilirken bir hata oluştu.';
            formMsg.className = 'msg error';
          }
        };
        reader.readAsDataURL(file);
      };
    });

    postForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      formMsg.textContent = '';
      formMsg.className = 'msg';

      const title  = postForm.title.value.trim();
      const author = postForm.author.value.trim();

      const plainText   = quill.getText().trim();
      const rawHTML     = quill.root.innerHTML.trim();
      const htmlContent = prepareContentForSave(rawHTML);

      if (!title || !plainText) {
        formMsg.textContent = 'Başlık ve içerik zorunlu.';
        formMsg.classList.add('error');
        return;
      }

      try{
        const docRef = await db.collection('posts').add({
          title,
          author: author || 'STEMCELL Team',
          content: htmlContent,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        postForm.reset();
        quill.setContents([]);
        formMsg.textContent = 'Yazı başarıyla eklendi!';
        formMsg.classList.add('success');

        const newSnap = await docRef.get();
        allPosts.unshift({ id: docRef.id, data: newSnap.data() });
        rebuildAuthorFilter();
        applyFiltersAndRender();

      }catch(err){
        console.error('Yazı eklenirken hata:', err);
        formMsg.textContent = 'Bir hata oluştu.';
        formMsg.classList.add('error');
      }
    });

    async function loadPostsOnce(){
      try{
        const snap = await db.collection('posts')
          .orderBy('createdAt','desc')
          .get();

        allPosts = snap.docs.map(doc => ({
          id: doc.id,
          data: doc.data()
        }));

        rebuildAuthorFilter();
        applyFiltersAndRender();

      }catch(err){
        console.error('Postlar alınırken hata:', err);
        postsList.innerHTML = '';
        const p = document.createElement('p');
        p.className = 'placeholder';
        p.textContent = 'Yazılar yüklenemedi.';
        postsList.appendChild(p);
      }
    }

    function rebuildAuthorFilter(){
      const authors = new Set();
      allPosts.forEach(p => {
        const a = (p.data.author || 'STEMCELL Team').trim();
        if(a) authors.add(a);
      });

      const prev = currentAuthor;
      authorFilter.innerHTML = '<option value="all">Tüm yazarlar</option>';

      Array.from(authors).sort().forEach(a=>{
        const opt = document.createElement('option');
        opt.value = a;
        opt.textContent = a;
        authorFilter.appendChild(opt);
      });

      if(prev && Array.from(authors).includes(prev)){
        authorFilter.value = prev;
      }else{
        currentAuthor = 'all';
      }
    }

    function applyFiltersAndRender(){
      const search = currentSearch.toLowerCase();

      const filtered = allPosts.filter(p=>{
        const d = p.data;
        const title  = (d.title || '').toLowerCase();
        const html   = d.content || '';
        const plain  = html.replace(/<[^>]+>/g,' ').toLowerCase();
        const author = (d.author || 'STEMCELL Team');

        if (currentAuthor !== 'all' && author !== currentAuthor) return false;
        if (search && !title.includes(search) && !plain.includes(search)) return false;
        return true;
      });

      renderList(filtered);
    }

    function renderList(posts){
      postsList.innerHTML = '';

      if(posts.length === 0){
        const p = document.createElement('p');
        p.className = 'placeholder';
        p.textContent = 'Filtreye uyan yazı bulunamadı.';
        postsList.appendChild(p);
        return;
      }

      posts.forEach(p=>{
        const item = renderPostItem(p);
        postsList.appendChild(item);
      });
    }

    function renderPostItem(p){
      const d = p.data;
      const item = document.createElement('div');
      item.className = 'post-item';

      if (currentOpenPostId === p.id) item.classList.add('active');

      const titleEl = document.createElement('div');
      titleEl.className = 'post-item-title';
      titleEl.textContent = d.title || '(Başlıksız)';

      const metaEl = document.createElement('div');
      metaEl.className = 'post-item-meta';
      const dateText = formatRelativeDate(d.createdAt);
      metaEl.textContent = `${d.author || 'STEMCELL Team'} • ${dateText}`;

      const excerptEl = document.createElement('div');
      excerptEl.className = 'post-item-excerpt';
      const plain = (d.content || '').replace(/<[^>]+>/g,' ').trim();
      excerptEl.textContent = plain.length > 140 ? plain.slice(0,140)+'…' : plain;

      item.appendChild(titleEl);
      item.appendChild(metaEl);
      item.appendChild(excerptEl);

      item.addEventListener('click', ()=>{
        if (currentOpenPostId === p.id) {
          currentOpenPostId = null;
          detailBox.innerHTML = '';
          detailBox.classList.add('hidden');
          document.querySelectorAll('.post-item.active').forEach(el=>el.classList.remove('active'));
        } else {
          currentOpenPostId = p.id;
          showDetail(p);
          document.querySelectorAll('.post-item.active').forEach(el=>el.classList.remove('active'));
          item.classList.add('active');
        }
      });

      return item;
    }

    async function showDetail(p){
      const d = p.data;
      const dateText = formatRelativeDate(d.createdAt);

      detailBox.classList.remove('hidden');
      detailBox.innerHTML = `
        <h2>${escapeHTML(d.title || '(Başlıksız)')}</h2>
        <div class="detail-meta">
          ${escapeHTML(d.author || 'STEMCELL Team')} • ${dateText}
        </div>
        <div class="detail-content">
          ${d.content || ''}
        </div>
      `;

      await resolveImagesIn(detailBox);

      if (window.hljs) hljs.highlightAll();
    }

    searchInput.addEventListener('input', ()=>{
      currentSearch = searchInput.value.trim();
      applyFiltersAndRender();
    });

    authorFilter.addEventListener('change', ()=>{
      currentAuthor = authorFilter.value;
      applyFiltersAndRender();
    });

    function openImageModal(src){
      imageModalImg.src = src;
      imageModal.style.display = 'flex';
    }

    imageModalClose.addEventListener('click', ()=>{
      imageModal.style.display = 'none';
      imageModalImg.src = '';
    });

    imageModal.addEventListener('click', (e)=>{
      if (e.target === imageModal) {
        imageModal.style.display = 'none';
        imageModalImg.src = '';
      }
    });

    document.addEventListener('click', (e)=>{
      const img = e.target;
      if (img.tagName === 'IMG' &&
          (img.closest('.ql-editor') || img.closest('.detail-content'))) {
        if (img.src) openImageModal(img.src);
      }
    });

    loadPostsOnce();
  </script>
</body>
</html>
